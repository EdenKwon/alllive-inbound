<!DOCTYPE html>
<html th:replace="~{fragment/layout.html :: layout(~{::section})}" xmlns:th="http://www.thymeleaf.org">

<section>
    <div class="container-fluid">

        <!-- Page Heading -->
        <h1 class="h3 mb-2 text-gray-800">입고 요청서</h1>
        <div class="card shadow">
            <div class="card-body">
                <h5>입고 요청 정보</h5>
                <table class="table table-bordered">
                    <tr>
                        <th>회사</th>
                        <td>00제약</td>
                    </tr>
                    <tr>
                        <th>창고</th>
                        <td>서울창고</td>
                    </tr>
                    <tr>
                        <th>입고요청코드</th>
                        <td>ib-rq-001</td>
                    </tr>
                    <tr>
                        <th>등록일자</th>
                        <td>2024-09-26</td>
                    </tr>
                    <tr>
                        <th>입고요청상태</th>
                        <td>요청 대기중</td>
                    </tr>
                </table>
            </div>
        </div>


        <!-- DataTales Example -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">입고 요청 리스트</h6>

            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="inputTable" width="100%" cellspacing="0">
                        <thead>
                        <tr>
                            <th>번호</th>
                            <th>의약품</th>
                            <th>파레트 수량</th>
                            <th>박스 수량</th>
                            <th>제조번호</th>
                            <th>유효기간</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="dto : ${responseDTO}">
                            <th scope="row" th:text="${dto.id}"></th>
                            <td th:text="${dto.product.name}"></td>
                            <td>
                                <select name="palletQuantity" th:value="${dto.palletQuantity}">
                                    <option th:each="i : ${#numbers.sequence(1, 100)}" th:value="${i}" th:text="${i}" th:selected="${dto.palletQuantity == i}"></option>
                                </select>
                            </td>
                            <td>
                                <select name="boxQuantity" th:value="${dto.boxQuantity}">
                                    <option th:each="i : ${#numbers.sequence(1, 100)}" th:value="${i}" th:text="${i}" th:selected="${dto.boxQuantity == i}"></option>
                                </select>
                            </td>
                            <td>
                                <input type="text" name="manufactureNum" th:value="${dto.manufactureNum}">
                            </td>
                            <td>
                                <input type="date" name="expDate" th:value="${dto.expDate}">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="form-container">
                        <form th:action="@{/inbound-requests}" method="get">
                            <button class="submit btn btn-primary" type="submit">취소</button>
                        </form>
                        <button id="submitBtn" class="submit" type="button">등록</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script th:inline="javascript">
        var id = [[${responseDTO[0].inboundRequest.id}]];

        document.getElementById('submitBtn').addEventListener('click', function(event) {
            event.preventDefault();

            var tableBody = document.getElementById('inputTable').getElementsByTagName('tbody')[0];
            var rows = tableBody.getElementsByTagName('tr');
            var products = [];

            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].getElementsByTagName('td');
                products.push({
                    productId: cells[0].textContent, // 제품 ID를 첫 번째 셀의 텍스트 내용으로 가정
                    palletQuantity: cells[1].getElementsByTagName('select')[0].value,
                    boxQuantity: cells[2].getElementsByTagName('select')[0].value,
                    manufactureNum: cells[3].getElementsByTagName('input')[0].value,
                    expDate: cells[4].getElementsByTagName('input')[0].value,
                    inboundRequestId: id
                });
            }

            var data = {
                inboundProductUpdateDTOList: products
            };

            var id = /*[[${responseDTO[0].inboundRequest.id}]]*/ null; // Thymeleaf를 사용하여 서버에서 가져옴

            fetch('/inbound-requests/' + id + '/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // 서버 응답을 JSON으로 파싱
                })
                .then(data => {
                    console.log('Success:', data);
                    window.location.href = '/inbound-requests';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('오류가 발생했습니다: ' + error.message);
                });
        });
    </script>
</section>

</html>

